---
const repo = import.meta.env.PUBLIC_GISCUS_REPO ?? "Lapis0x0/blog-discussion"
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID ?? "R_kgDONda6_g"
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY ?? "General"
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID ?? "DIC_kwDONda6_s4ClN0E"
const isEnabled = Boolean(repo && repoId && category && categoryId)
---

{isEnabled && (
  <section class="mt-8 pt-0 pb-12">
    <div class="px-6">
      <div class="max-w-3xl mx-auto">
        <div class="giscus-container"
          data-repo={repo}
          data-repo-id={repoId}
          data-category={category}
          data-category-id={categoryId}
        ></div>
        <script is:inline>
          (() => {
            const getTheme = () =>
              document.documentElement.classList.contains("dark") ? "dark" : "light";

            const loadGiscus = () => {
              const container = document.querySelector(".giscus-container");
              if (!container) return;

              // 清除已有的 giscus
              const existingGiscus = container.querySelector(".giscus");
              if (existingGiscus) {
                existingGiscus.remove();
              }

              const repo = container.dataset.repo;
              const repoId = container.dataset.repoId;
              const category = container.dataset.category;
              const categoryId = container.dataset.categoryId;

              const script = document.createElement("script");
              script.src = "https://giscus.app/client.js";
              script.dataset.repo = repo;
              script.dataset.repoId = repoId;
              script.dataset.category = category;
              script.dataset.categoryId = categoryId;
              script.dataset.mapping = "pathname";
              script.dataset.strict = "0";
              script.dataset.reactionsEnabled = "0";
              script.dataset.emitMetadata = "0";
              script.dataset.inputPosition = "bottom";
              script.dataset.theme = getTheme();
              script.dataset.lang = "zh-CN";
              script.crossOrigin = "anonymous";
              script.async = true;

              container.appendChild(script);
            };

            const updateTheme = () => {
              const iframe = document.querySelector("iframe.giscus-frame");
              if (!iframe) return;
              iframe.contentWindow?.postMessage(
                { giscus: { setConfig: { theme: getTheme() } } },
                "https://giscus.app"
              );
            };

            // 监听主题变化
            const observer = new MutationObserver((mutations) => {
              for (const mutation of mutations) {
                if (mutation.attributeName === "class") {
                  updateTheme();
                }
              }
            });
            observer.observe(document.documentElement, { attributes: true });

            // 初始加载和页面切换时重新加载
            loadGiscus();
            document.addEventListener("astro:page-load", loadGiscus);
          })();
        </script>
      </div>
    </div>
  </section>
)}
