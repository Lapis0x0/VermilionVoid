---
/**
 * æ–‡ç« å¯†ç ä¿æŠ¤ç»„ä»¶
 * ä½¿ç”¨æ„å»ºæ—¶åŠ å¯†çš„å†…å®¹å’Œå¯†ç å“ˆå¸ŒéªŒè¯
 */
interface Props {
	slug: string;
	encryptedData?: {
		content: string;
		hash: string;
	};
	class?: string;
}

const { slug, encryptedData, class: className = "" } = Astro.props;
const formId = `password-form-${slug}`;
const contentId = `article-content-${slug}`;
const overlayId = `overlay-${slug}`;
const encryptedDataString = encryptedData ? JSON.stringify(encryptedData) : "";
---

<div id={overlayId} class={`password-protection-overlay ${className}`}>
  <div class="password-container rounded-xl border border-border bg-card p-6 md:p-8 max-w-md w-full shadow-xl">
    <h3 class="font-bold text-xl mb-4 text-foreground">ğŸ”’ æ­¤æ–‡ç« å·²åŠ å¯†</h3>
    <p class="mb-6 text-muted-foreground">æœ¬æ–‡ç« å†…å®¹å¯èƒ½å¿¤é€†éƒ¨åˆ†è¯»è€…æ‰€æŒçš„æ€æ½®ç«‹åœºã€å¹´é¾„èƒŒæ™¯æˆ–å…´è¶£åå¥½ã€‚è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œè‹¥æ‚¨ä¸æ¸…æ¥šå¯†ç ï¼Œè¯·è”ç³»åšä¸»è·å–ã€‚</p>
    <form id={formId} class="flex flex-col">
      <input 
        type="password" 
        class="mb-4 p-2.5 rounded-md border border-border bg-background text-foreground w-full focus:outline-none focus:ring-2 focus:ring-primary/30" 
        placeholder="è¯·è¾“å…¥å¯†ç " 
        required
      />
      <button 
        type="submit" 
        class="bg-primary hover:opacity-90 rounded-md py-2 px-4 text-primary-foreground font-medium transition-colors"
      >
        è§£é”å†…å®¹
      </button>
      <p id="error-message" class="text-red-500 mt-2 text-sm hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
    </form>
  </div>
</div>

<style>
.password-protection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: oklch(0 0 0 / 0.35);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 20;
  backdrop-filter: blur(5px);
}

.password-container {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.hidden-overlay {
  animation: fadeOut 0.3s forwards;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; visibility: hidden; }
}

/* ç¡®ä¿åŠ å¯†å†…å®¹åœ¨é¡µé¢æºç ä¸­ä¸å¯è§ */
.encrypted-content {
  display: none !important;
}

.encrypted-content.unlocked {
  display: block !important;
}
</style>

<script
  is:inline
  data-slug={slug}
  data-form-id={formId}
  data-content-id={contentId}
  data-overlay-id={overlayId}
  data-encrypted={encryptedDataString}
>
  // @ts-nocheck
(function () {
  const currentScript = document.currentScript

  if (!currentScript) {
    return
  }

  const {
    slug: slugAttr = '',
    formId: formIdAttr = '',
    contentId: contentIdAttr = '',
    overlayId: overlayIdAttr = '',
    encrypted: encryptedAttr = '',
  } = currentScript.dataset ?? {}

  let encryptedPayload = null

  if (encryptedAttr) {
    try {
      encryptedPayload = JSON.parse(encryptedAttr)
    } catch (error) {
      console.error('è§£æåŠ å¯†å†…å®¹å¤±è´¥:', error)
    }
  }

  function loadLibraries() {
    return new Promise((resolve, reject) => {
      let loadedCount = 0
      const totalLibs = 2

      const checkComplete = () => {
        loadedCount += 1
        if (loadedCount === totalLibs) {
          resolve()
        }
      }

      if (!window.CryptoJS) {
        const cryptoScript = document.createElement('script')
        cryptoScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js'
        cryptoScript.onload = () => checkComplete()
        cryptoScript.onerror = () => reject(new Error('Failed to load crypto-js'))
        document.head.appendChild(cryptoScript)
      } else {
        checkComplete()
      }

      if (!window.dcodeIO) {
        const bcryptScript = document.createElement('script')
        bcryptScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js'
        bcryptScript.onload = () => checkComplete()
        bcryptScript.onerror = () => reject(new Error('Failed to load bcryptjs'))
        document.head.appendChild(bcryptScript)
      } else {
        checkComplete()
      }
    })
  }

  const hideOverlay = () => {
    const overlayElement = document.getElementById(overlayIdAttr)
    if (overlayElement instanceof HTMLElement) {
      overlayElement.classList.add('hidden-overlay')
    }
  }

  const renderMarkdownContent = (markdown, targetElement) => {
    const render = () => {
      const markedModule = window.marked
      if (!markedModule) {
        console.error('Marked is not available')
        return
      }
      const html = markedModule.parse(markdown)
      targetElement.innerHTML = `<div class="w-full !max-w-none custom-md dark:prose-invert prose prose-base" data-pagefind-body>${html}</div>`
      targetElement.classList.remove('hidden')
      targetElement.classList.add('unlocked')
    }

    if (!window.marked) {
      const markedScript = document.createElement('script')
      markedScript.src = 'https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.umd.js'
      markedScript.onload = () => {
        const markedGlobal = window.marked
        if (markedGlobal) {
          window.marked = markedGlobal
        }
        render()
      }
      markedScript.onerror = () => {
        console.error('Failed to load marked')
      }
      document.head.appendChild(markedScript)
    } else {
      render()
    }
  }

  function initEncryption() {
    if (!encryptedPayload || !slugAttr || !formIdAttr || !contentIdAttr) {
      return
    }

    const storageKey = `fuwari-unlocked-${slugAttr}`
    const isUnlocked = localStorage.getItem(storageKey) === 'true'

    if (isUnlocked) {
      const cachedContent = localStorage.getItem(`fuwari-content-${slugAttr}`)
      if (cachedContent) {
        const contentElement = document.getElementById(contentIdAttr)
        if (contentElement instanceof HTMLElement) {
          renderMarkdownContent(cachedContent, contentElement)
          hideOverlay()
        }
      }
    }

    const formElement = document.getElementById(formIdAttr)
    if (!(formElement instanceof HTMLFormElement)) {
      return
    }

    formElement.addEventListener('submit', (event) => {
      event.preventDefault()

      const bcryptModule = window.dcodeIO?.bcrypt
      const cryptoModule = window.CryptoJS
      if (!bcryptModule || !cryptoModule) {
        console.error('Encryption libraries are not loaded yet')
        return
      }

      const passwordInput = formElement.querySelector('input[type="password"]')
      const submitButton = formElement.querySelector('button[type="submit"]')
      const errorElement = document.getElementById('error-message')

      if (!passwordInput || !submitButton || !errorElement) {
        return
      }

      const originalText = submitButton.textContent ?? ''
      submitButton.textContent = 'éªŒè¯ä¸­...'
      submitButton.disabled = true

      try {
        const isValidPassword = bcryptModule.compareSync(passwordInput.value, encryptedPayload.hash)

        if (isValidPassword) {
          const decryptedBytes = cryptoModule.AES.decrypt(
            encryptedPayload.content,
            passwordInput.value,
          )
          const decryptedMarkdown = decryptedBytes.toString(cryptoModule.enc.Utf8)

          if (decryptedMarkdown) {
            localStorage.setItem(storageKey, 'true')
            localStorage.setItem(`fuwari-content-${slugAttr}`, decryptedMarkdown)

            const contentElement = document.getElementById(contentIdAttr)
            if (contentElement instanceof HTMLElement) {
              renderMarkdownContent(decryptedMarkdown, contentElement)
              hideOverlay()
            }

            errorElement.classList.add('hidden')
            passwordInput.value = ''
          } else {
            throw new Error('è§£å¯†å¤±è´¥')
          }
        } else {
          errorElement.classList.remove('hidden')
          passwordInput.value = ''
        }
      } catch (error) {
        console.error('éªŒè¯å¤±è´¥:', error)
        errorElement.classList.remove('hidden')
        passwordInput.value = ''
      } finally {
        submitButton.textContent = originalText
        submitButton.disabled = false
      }
    })
  }

  const start = () => {
    loadLibraries().then(initEncryption).catch((error) => {
      console.error('åˆå§‹åŒ–å¯†ç ä¿æŠ¤å¤±è´¥:', error)
    })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start)
  } else {
    start()
  }
})()
</script>
