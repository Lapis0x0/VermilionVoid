---
import "@/styles/global.css"

interface Props {
  title?: string
  description?: string
}

const defaultTitle = "时歌的博客 | Boundary of Thought"
const defaultDescription = "探索金融、社会与人工智能的交汇点"

const { title = defaultTitle, description = defaultDescription } = Astro.props as Props
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="icon" href="/icon-light-32x32.png" media="(prefers-color-scheme: light)" />
    <link rel="icon" href="/icon-dark-32x32.png" media="(prefers-color-scheme: dark)" />
    <link rel="icon" href="/icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-icon.png" />
    <script is:inline>
      // 主题初始化 - 防止页面加载闪烁
      (function() {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>
  </head>
  <body class="bg-background text-foreground">
    <div id="swup-container" class="transition-swup-fade">
      <slot />
    </div>
    <script is:inline>
      // @ts-nocheck
      const setupSwupHooks = () => {
        if (!window?.swup?.hooks) return
        window.swup.hooks.on('link:click', () => {
          document.documentElement.style.setProperty('--content-delay', '0ms')
        })
      }

      if (window?.swup?.hooks) {
        setupSwupHooks()
      } else {
        document.addEventListener('swup:enable', setupSwupHooks)
      }
    </script>
    <script is:inline>
      // @ts-nocheck
      const HOME_SCROLL_KEY = "homeScrollTarget"
      const HOME_SCROLL_INSTANT_KEY = "homeScrollInstant"
      const HOME_TARGET_FALLBACK = "home-main"
      let handledBySwup = false
      let instantScrollActive = false
      let previousScrollBehavior = null

      const normalizePathname = () => {
        const raw = window.location.pathname || "/"
        const trimmed = raw.replace(/\/+$/, "")
        return trimmed || "/"
      }

      const isPostDetail = () => {
        const path = normalizePathname()
        return path.startsWith("/posts/") && path !== "/posts"
      }

      const isHomePagination = () => {
        const path = normalizePathname()
        return /^\/\d+$/.test(path)
      }

      const setInstantScroll = (enabled) => {
        const root = document.documentElement
        const body = document.body
        if (enabled) {
          if (!previousScrollBehavior) {
            previousScrollBehavior = {
              root: root.style.scrollBehavior,
              body: body?.style.scrollBehavior ?? "",
            }
          }
          root.style.scrollBehavior = "auto"
          if (body) body.style.scrollBehavior = "auto"
          return
        }

        if (!previousScrollBehavior) return
        root.style.scrollBehavior = previousScrollBehavior.root
        if (body) body.style.scrollBehavior = previousScrollBehavior.body
        previousScrollBehavior = null
      }

      const enableInstantScroll = () => {
        setInstantScroll(true)
        instantScrollActive = true
      }

      const disableInstantScroll = () => {
        if (!instantScrollActive) return
        setInstantScroll(false)
        instantScrollActive = false
      }

      const rememberHomeTarget = (targetId) => {
        if (!targetId) return
        if (!isPostDetail() && !isHomePagination()) return
        sessionStorage.setItem(HOME_SCROLL_KEY, targetId)
        sessionStorage.setItem(HOME_SCROLL_INSTANT_KEY, "1")
        enableInstantScroll()
      }

      const handleHomeLinkClick = (event) => {
        const link = event.target?.closest?.("a[data-home-target]")
        if (!link) return
        const targetId = link.getAttribute("data-home-target") || HOME_TARGET_FALLBACK
        rememberHomeTarget(targetId)
      }

      const scrollToRememberedTarget = () => {
        if (normalizePathname() !== "/") return
        const targetId = sessionStorage.getItem(HOME_SCROLL_KEY)
        if (!targetId) return
        const target = document.getElementById(targetId)
        if (!target) return
        if (sessionStorage.getItem(HOME_SCROLL_INSTANT_KEY)) {
          enableInstantScroll()
        }
        sessionStorage.removeItem(HOME_SCROLL_KEY)
        sessionStorage.removeItem(HOME_SCROLL_INSTANT_KEY)
        target.scrollIntoView({ behavior: "auto", block: "start" })
      }

      const handleSwupVisitStart = (event) => {
        const visit = event?.detail?.visit
        if (!visit) return
        if (visit?.history?.popstate) return
        const hasHash = !!visit?.to?.hash
        if (hasHash) return
        const targetId = sessionStorage.getItem(HOME_SCROLL_KEY)
        if (targetId) {
          const toUrl = visit?.to?.url || ""
          const normalized = toUrl.replace(/\?.*$/, "").replace(/\/+$/, "") || "/"
          if (normalized === "/") {
            visit.scroll.target = `#${targetId}`
            visit.scroll.animate = false
            handledBySwup = true
            enableInstantScroll()
            return
          }
        }

        visit.scroll.animate = false
        enableInstantScroll()
      }

      const handleSwupPageView = () => {
        if (handledBySwup) {
          sessionStorage.removeItem(HOME_SCROLL_KEY)
          sessionStorage.removeItem(HOME_SCROLL_INSTANT_KEY)
          handledBySwup = false
          requestAnimationFrame(() => disableInstantScroll())
          return
        }
        scrollToRememberedTarget()
        requestAnimationFrame(() => disableInstantScroll())
      }

      document.addEventListener("click", handleHomeLinkClick, { capture: true })
      document.addEventListener("swup:visit:start", handleSwupVisitStart)
      window.addEventListener("pageshow", () => {
        requestAnimationFrame(() => {
          scrollToRememberedTarget()
          requestAnimationFrame(() => disableInstantScroll())
        })
      })
      document.addEventListener("swup:page:view", handleSwupPageView)
    </script>
  </body>
</html>
